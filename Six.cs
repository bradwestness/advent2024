namespace advent;

public sealed class Six : IAdventDay
{
    public string ExecutePartOne(string input)
    {
        var puzzle = Puzzle.ParseInput(input);

        while (puzzle.Guard != Guard.Empty)
        {
            puzzle.MoveOne();
        }

        var total = puzzle.VisitedPositions.Count;

        return $"Total distinct positions visited by the guard before leaving the mapped area: {total}";
    }

    public string ExecutePartTwo(string input)
    {
        var puzzle = Puzzle.ParseInput(input);

        var obstaclePositionsThatCauseLoops = new List<Position>();

        for (var row = 0; row < puzzle.Rows; row++)
        {
            for (var col = 0; col < puzzle.Cols; col++)
            {
                Position position = new(row, col);

                if (!puzzle.IsObstacle(position) && position != puzzle.Guard.Position)
                {
                    Puzzle attempt = puzzle.WithObstacle(position);

                    if (attempt.IsLoop())
                    {
                        obstaclePositionsThatCauseLoops.Add(position);
                    }
                }
            }
        }

        var total = obstaclePositionsThatCauseLoops.Count;

        return $"Total obstacle positions which cause the guard to enter a loop: {total}";
    }

    private enum CardinalDirection
    {
        Unknown = 0,
        North,
        East,
        South,
        West,
    }

    private record struct Position(int Row, int Col)
    {
        public static readonly Position Unknown = new(-1, -1);
    }

    private record struct Guard(Position Position, CardinalDirection Direction)
    {
        public static readonly Guard Empty = new(Position.Unknown, CardinalDirection.Unknown);

        public CardinalDirection RightTurn => Direction switch
        {
            CardinalDirection.North => CardinalDirection.East,
            CardinalDirection.East => CardinalDirection.South,
            CardinalDirection.South => CardinalDirection.West,
            CardinalDirection.West => CardinalDirection.North,
            _ => CardinalDirection.Unknown,
        };
    };

    private sealed class Puzzle(char[,] grid, Guard guard)
    {
        private readonly List<Position> visitedPositions = new List<Position>();

        public int Rows => grid.GetLength(0);

        public int Cols => grid.GetLength(1);

        public IReadOnlyList<Position> VisitedPositions => visitedPositions;

        public Guard Guard => guard;

        public static Puzzle ParseInput(string input)
        {
            var lines = input.Split(Environment.NewLine, StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries);
            var grid = new char[lines.Length, lines.First().Length];
            var guard = Guard.Empty;

            for (var row = 0; row < lines.Length; row++)
            {
                var line = lines[row].ToCharArray();

                for (var col = 0; col < line.Length; col++)
                {
                    char c = line[col];

                    grid[row, col] = c;

                    if (c == '^')
                    {
                        guard = new(new(row, col), CardinalDirection.North);
                    }
                }
            }

            return new Puzzle(grid, guard);
        }

        public void MoveOne()
        {
            if (guard == Guard.Empty)
            {
                return;
            }

            if (!visitedPositions.Contains(guard.Position))
            {
                visitedPositions.Add(guard.Position);
            }

            Position newPosition = guard.Direction switch
            {
                CardinalDirection.North => new(guard.Position.Row - 1, guard.Position.Col),
                CardinalDirection.East => new(guard.Position.Row, guard.Position.Col + 1),
                CardinalDirection.South => new(guard.Position.Row + 1, guard.Position.Col),
                CardinalDirection.West => new(guard.Position.Row, guard.Position.Col - 1),
                _ => Position.Unknown,
            };

            if (!IsWithinGrid(newPosition))
            {
                guard = Guard.Empty;
                return;
            }

            if (IsObstacle(newPosition))
            {
                guard = guard with { Direction = guard.RightTurn, };
                return;
            }

            guard = new(newPosition, guard.Direction);

            if (!visitedPositions.Contains(guard.Position))
            {
                visitedPositions.Add(guard.Position);
            }
        }

        public bool IsObstacle(Position position) =>
            IsWithinGrid(position) && grid[position.Row, position.Col] == '#';

        private bool IsWithinGrid(Position position) =>
            position.Row >= 0
            && position.Row < grid.GetLength(0)
            && position.Col >= 0
            && position.Col < grid.GetLength(1);

        public Puzzle WithObstacle(Position position)
        {
            var copy = (char[,])grid.Clone();

            copy[position.Row, position.Col] = '#';

            return new Puzzle(copy, guard);
        }

        public bool IsLoop()
        {
            var positions = new Dictionary<CardinalDirection, IList<Position>>();

            foreach (CardinalDirection direction in Enum.GetValues<CardinalDirection>())
            {
                positions[direction] = new List<Position>();
            }

            while (Guard != Guard.Empty)
            {
                if (positions[Guard.Direction].Contains(guard.Position))
                {
                    // the guard has already traveled through this position
                    // in the same direction, so it's a loop
                    return true;
                }

                positions[Guard.Direction].Add(guard.Position);
                MoveOne();
            }

            return false;
        }
    }

    public string GetExampleInput() =>
    @"....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...";

    public string GetInput() =>
    @"............#...........................................#.......#.............#...........#.......................................
..........#....................#.........................................#............#............#.....##...................#...
.#.........#..........#.....#......##...............................................................#..................#..........
...........#.#...................#..................#.......................#........#............#...............................
...#..........................#............................#..................#..................#..........##..................#.
..............................................................................#...................................#..........#.#..
.#......##........#.........#...........#...............................#...................#........#..#............#.........##.
.....................................#...................................................................#........................
......................#......................#.............................................#......................................
....................................................#...........#........................#...................#......#.#.........##
..................#..#..........#...........................#.#..........#.......##....................#.#....#..#................
............#...#..........................#.............................................................................#........
...............................#.............#.........#..........................................................................
.....#......#........#.#...............#.........................#.......#.......#.........................#......................
...#....#........................##.................#..#...............................#..........#...............................
..........#......#..............................................................#...................#..........#.........#.#......
#.............#.........#.................................#....................#....................#......................#......
....#.............................................#..................#.........#...#................#........#....#..........#....
.......#......................................#.......#..........................................................#................
...#..#..............#.........#......#...........................................#..............................###.....#........
......................................................#........#..............................#..................#................
.......................................#.....#.........................................................................#..........
...........................#...........#....................................#.........#...........................................
....#........#...................................................................#...................................#............
....#..#.................................................#........................#...............................................
............................................................##..#......................#.......#...........#..#........#..........
........#.........................................................................................................................
............#......#.........#...............##...............................#......#......................#......#..............
.#......#...............................................#.#........................#....#.....#..#................##..............
.........#.....#.............#.........#.............................#.................#.........##.......#.......................
...#..............................................................................#....................#..........................
.#...#.....#..............#.................................................#..............................................#......
....................................................#...#..................................................................#......
..............#................#.......................................................................#.........#................
...........#..............................#.....#.........#..#............................#.......................................
.........................#............#..................................#...#.....#......#.......................................
..........#......................#...#....#......#.....................#..................................#.....#........#........
.............#...#........#.........................................#..#........................................................#.
.....#...............#......#.........##.....#.......................#..............#....................................#...#....
.....................#..........................................................................................#.............#...
.................#.............#..............##...................................................#..............................
..................................#.......#.......................................#...........#...................................
...#..............#............................#.#................................................................................
..........#.......#...........................#...........................#..............................#....................#...
.....#...#...#.................#..........................................................#............#.....................#.#..
...#...#......#.............#...............................................................................#...##................
..........#.....#.......#............#........................#..........................................#.............#..........
..................................................#.................#.........................#.#.......#.........................
.............................#...............................#.#............#................#...................#...............#
..#...........#........................#............................................#...........#............#....................
.......................#...#...........................#............#..#..#............#..#..............................#........
.......#...........#...............#.............................................................................#................
...........................#................................#....#....#...#..................#...................#.#..........##..
...#.#.......................................................................................#.....#..........#..........#........
....#......#.......................................................#.......#.#............................#.......................
.#.................#...#........#...#...........................#...#.................^......#............#.......................
...........#................##..........................................................................#.........................
...........................................................#....#............................#........#...........................
.#......#....#..#.......#....................#...............................................#........#...........................
......................##..............##.......................#...#...............#........................#................#....
#..................................................................................................#..........#...................
.....................#...................................................................................#............#.....#.....
..........................##.#............................................#........#.#.......#.#....#...#.........................
....#...............#.................................................................................#..#...........##...........
.................................................................#.#.....#.........#...............#..............................
.......................................................#.......#.........#............#....#..........#.....................#.....
#..............................................#..#..................#....................#.......................#....#....#.....
................#...............#..............................................................#....#...........................#.
.#...............#..#....................#...........................................#............................................
................................#...........................................#.........................#..#........................
.......#......#........................................#....................................................#.....................
.#......................#........................#...............#......................#...........#.............................
........#.......#..................#.......................#.........#.....................................................#.....#
..................#.....................#...#..........................................................#.............#............
....#........................#......#...#.....................#....##.........#...................................................
......................#....................#....................................................#..........#..................#...
.......#..........#.....................#.................................................#.......................................
....................#.......................................................#....##...................................#...........
................................#.............................................#.....#..............#..............................
..#.....#.......#..................................#........................#.....................................................
...##........#.#........#.........................................#..............#......................................#.........
........................................................................................#.........................................
.......................#......#...........................................................................#.......................
.........#...................#.............................................................#.........#............................
..........................#.................................................#................#...................................#
...............................#......................................#.........................#....#......#................#....
..........#.......................................................................................................................
....#......#.#.................#.#.......#.........#...#................#...............#..............#.....................#....
....#.........#....#................#..........#........#...................#.............#...............#..........#...#........
................#...............#.....#.....#...........#....#....................#.....#...................#.....................
.......................#.......................#...........................................................#.....................#
#.................................................................................................#...............................
.........................................##..#........#............................#............#........................#........
....................#...............#............#................................................................................
...#................#............#..............................................................#.#.................###...........
......#...........................#.......#....#...............#....................................................#.....#.......
..#.......##.....................#................#.....................................................#.#......................#
.................................................................#.................................##.............................
....#..............................................#................................................................#....#........
................#................................................#..............................................#...#...........#.
...................................##...............................................................................#.............
............#.................#..#.........................#..........................#.......#...................................
.......##........#.#...#......................................#..............#...............................#.............#......
............#.............................................##..............................#............................#..........
.................................................#..........................#.........#...#...............................#.......
..#............#......................#.....................................#.....##.........................#....................
...........#......#............#...................#.......................#..##........................................#.........
.................................##......#.........#.......#..................##...............#..................................
........#.........#...##.........#.#......#.........#.......#.....#.......................#.......................................
..................................#..............#................#.....#..............##...............#.........................
................#..........................................#..#.......#....................................#......................
..................................................#...........#..........................#.................#......................
.........#....................................................#..........#........................................#...............
..........................#..............................................#.................................................#......
...#....................................#.......................#.#.......#............##........#........................#.......
...#..................................#.....#...........................................................#...#........#............
................#...........#.........................................................#...............#....................#....#.
.................#...........#..............................#..........#........#............................#..........#.........
.........#.............................................#..........#....#.................#...................#...#................
......#....................#.................#.......#..............#............................#..#.......................#...#.
#.....#..........................#.....#...................................#...##.....#.....#...........#................#......#.
.##................#.........#.........#...#.#....................................................................................
.............................................................#..#...............#..#...............#.....#....#.............#..#..
.............#.........#.......#....#.........#...#......#........#.............................#.................................
#.....................................#.......#..................#..................#............#...#......#.........#...........
.......##............#.............#..............#.....#........#.................#..#..........#......................#..#......
......#......#.............#....#...............#.......#....................##.................................................##
...............#........#........#........................#.#........#.............#...................................#...##.....
................#........................#.......#......#..........................#................#............#...#....#.......
#.................#.....................#..........#.....................#...................##..........................#........";
}
